services:
  # --- SERVICIO 1: BASE DE DATOS ---
  db:
    image: postgres:15-alpine
    volumes:
      - postgres_data:/var/lib/postgresql/data
    environment:
      - POSTGRES_DB=${DB_NAME}
      - POSTGRES_USER=${DB_USER}
      - POSTGRES_PASSWORD=${DB_PASSWORD}
    networks:
      - app_network
    restart: always

  # --- SERVICIO 2: BACKEND ---
  web:
    build: 
      context: ./backend
      dockerfile: Dockerfile
    # Comando "Mágico": Migra, recolecta estáticos y arranca
    command: >
      sh -c "python manage.py migrate --noinput &&
             python manage.py collectstatic --noinput &&
             gunicorn --bind 0.0.0.0:8000 backend.wsgi:application"
    volumes:
      - static_volume:/app/staticfiles # Comparte estáticos con Nginx
      # IMPORTANTE: En producción NO montes código (- .:/app)
    env_file:
      - .env # Lee el archivo .env de la RAÍZ
    depends_on:
      - db
    networks:
      - app_network
    restart: always

  # --- SERVICIO 3: FRONTEND (Nginx) ---
  frontend:
    build: 
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - "80:80" # Único puerto abierto al mundo
    volumes:
      - static_volume:/app/staticfiles # Lee los estáticos de Django
    depends_on:
      - web
    networks:
      - app_network
    restart: always

networks:
  app_network:
    driver: bridge

volumes:
  postgres_data:
  static_volume: